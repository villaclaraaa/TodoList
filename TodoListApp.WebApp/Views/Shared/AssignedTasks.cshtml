@model IEnumerable<TodoListApp.WebApp.Models.TodoTaskModel>

@{
    ViewData["Title"] = $"Tasks Assigned to User {ViewBag.UserId}";

	string GetSortUrl(TaskSortOption sortOption, bool? descending = null)
    {
        bool isDescending = descending ?? (sortOption == ViewBag.SortBy ? !ViewBag.Descending : false);
        return Url.Action("AssignedTasks", new { 
            userId = ViewBag.UserId, 
            page = ViewBag.CurrentPage, 
            pageSize = ViewBag.PageSize, 
            sortBy = sortOption,
            descending = isDescending
        });
    }
}

<div class="container-fluid">
    <h1 class="my-4">Tasks Assigned to User @ViewBag.UserId</h1>
	<div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <label class="input-group-text" for="sortOptions">Sort by:</label>
                <select class="form-select" id="sortOptions" onchange="window.location.href=this.value">
                    <option value="@GetSortUrl(TaskSortOption.Default)" selected="@(ViewBag.SortBy == TaskSortOption.Default)">Created date</option>
                    <option value="@GetSortUrl(TaskSortOption.ByTitle, false)" selected="@(ViewBag.SortBy == TaskSortOption.ByTitle && !ViewBag.Descending)">Title (A-Z)</option>
                    <option value="@GetSortUrl(TaskSortOption.ByTitle, true)" selected="@(ViewBag.SortBy == TaskSortOption.ByTitle && ViewBag.Descending)">Title (Z-A)</option>
                    <option value="@GetSortUrl(TaskSortOption.ByDueDate, false)" selected="@(ViewBag.SortBy == TaskSortOption.ByDueDate && !ViewBag.Descending)">Due Date (Earliest First)</option>
                    <option value="@GetSortUrl(TaskSortOption.ByDueDate, true)" selected="@(ViewBag.SortBy == TaskSortOption.ByDueDate && ViewBag.Descending)">Due Date (Latest First)</option>
                </select>
            </div>
        </div>
    </div>
    @if (!Model.Any())
    {
        <div class="alert alert-info">
            No tasks assigned to this user.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Todo List</th>
                        <th>Status</th>
                        <th>Due Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var task in Model)
                    {
                        <tr class="@(task.IsOverdue ? "table-danger" : "")">
                            <td>@task.Title</td>
                            <td>
                                <a asp-controller="TodoList" asp-action="Details" asp-route-id="@task.TodoListId">
                                    View List
                                </a>
                            </td>
                            <td>
                                <span class="badge @(task.Status == TodoListApp.WebApp.Models.TaskStatus.Completed ? "bg-success" : 
                                       task.Status == TodoListApp.WebApp.Models.TaskStatus.InProgress ? "bg-primary" : "bg-secondary")">
                                    @task.Status
                                </span>
                            </td>
                            <td>
                                @(task.DueDate.HasValue ? task.DueDate.Value.ToString("yyyy-MM-dd") : "N/A")
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#taskDetailsModal-@task.Id">
                                        Details
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editTaskModal-@task.Id">
                                        Edit
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        @if (ViewBag.TotalCount > ViewBag.PageSize)
        {
            var totalPages = Math.Ceiling((double)ViewBag.TotalCount / ViewBag.PageSize);
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link" asp-action="AssignedTasks" asp-route-userId="@ViewBag.UserId" asp-route-page="@i" asp-route-pageSize="@ViewBag.PageSize">@i</a>
                        </li>
                    }
                </ul>
            </nav>
        }
        
        <!-- Task Details and Edit Modals -->
        @foreach (var task in Model)
        {
            <partial name="_TaskDetailsPartial" model="task" />
            <partial name="_EditTaskPartial" model="task" />
        }
    }
</div>
